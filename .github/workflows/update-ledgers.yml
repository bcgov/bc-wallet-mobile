# Update Indy Ledgers Strategy
#
# This workflow has two modes:
#
# 1. PR Check (automatic):
#    - Runs on every pull request
#    - Checks if ledgers.json is outdated by comparing against upstream sources
#    - PASSES if ledgers are up-to-date
#    - FAILS if ledgers need updating (blocks PR merge until fixed)
#
# 2. Manual Update (workflow_dispatch):
#    - Triggered manually from GitHub Actions UI
#    - Allows you to specify a branch name to update
#    - Fetches latest ledgers and commits them to the specified branch
#

name: Ledgers

permissions:
  contents: write

on:
  pull_request:
    types: [opened, synchronize, reopened]

  workflow_dispatch:
    inputs:
      branch_name:
        description: 'Branch name to update (e.g., feature/my-branch)'
        required: true
        type: string

jobs:
  # Job 1: Check if ledgers are up-to-date (runs on PRs)
  check-ledgers:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-22.04
    name: Check Indy ledgers are up-to-date
    steps:
      - name: Checkout bc-wallet-mobile
        uses: actions/checkout@v4

      - name: Setup NodeJS
        uses: ./.github/workflows/actions/setup-node

      - name: Cache app node_modules
        uses: actions/cache@v3
        with:
          path: .yarn/cache
          key: ${{ runner.os }}-yarn-${{ hashFiles('yarn.lock') }}
          restore-keys: ${{ runner.os }}-yarn-

      - name: Install dependencies
        working-directory: app
        run: yarn install --immutable

      - name: Fetch latest Indy ledgers
        run: node app/scripts/refresh-ledgers.cjs

      - name: Check for ledger changes
        id: check_changes
        run: |
          if git diff --quiet app/src/configs/ledgers/indy/ledgers.json; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Ledgers are up-to-date"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "‚ùå Ledgers are outdated"
            echo ""
            echo "=== Changes detected ==="
            git diff app/src/configs/ledgers/indy/ledgers.json
          fi

      - name: Fail if ledgers are outdated
        if: steps.check_changes.outputs.changed == 'true'
        env:
          HEAD_REF: ${{ github.head_ref }}
        run: |
          echo "::error::Indy ledgers are outdated! To fix this:"
          echo "::error::  1. Go to Actions ‚Üí Ledgers ‚Üí Run workflow"
          echo "::error::  2. Enter your branch name: ${HEAD_REF}"
          echo "::error::  3. Click 'Run workflow' to auto-update the ledgers"
          echo "::error::"
          echo "::error::Or run locally: node app/scripts/refresh-ledgers.cjs"
          exit 1

  # Job 2: Update ledgers on a specific branch (manual trigger)
  update-ledgers:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-22.04
    name: Update Indy ledgers on branch
    env:
      TARGET_BRANCH: ${{ inputs.branch_name }}
    steps:
      - name: Checkout branch
        uses: actions/checkout@v4
        with:
          ref: "${TARGET_BRANCH}"

      - name: Setup NodeJS
        uses: ./.github/workflows/actions/setup-node

      - name: Cache app node_modules
        uses: actions/cache@v3
        with:
          path: .yarn/cache
          key: ${{ runner.os }}-yarn-${{ hashFiles('yarn.lock') }}
          restore-keys: ${{ runner.os }}-yarn-

      - name: Install dependencies
        working-directory: app
        run: yarn install --immutable

      - name: Fetch latest Indy ledgers
        run: node app/scripts/refresh-ledgers.cjs

      - name: Check for ledger changes
        id: check_changes
        run: |
          if git diff --quiet app/src/configs/ledgers/indy/ledgers.json; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No changes needed - ledgers are already up-to-date"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "üìù Changes detected - will commit update"
          fi

      - name: Commit and push ledger updates
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add app/src/configs/ledgers/indy/ledgers.json
          git commit -m "chore(bot): updated Indy ledgers json file" --signoff
          git push origin "${TARGET_BRANCH}"
          echo "‚úÖ Ledgers updated and pushed to branch: ${TARGET_BRANCH}"

      - name: No changes needed
        if: steps.check_changes.outputs.changed == 'false'
        run: |
          echo "‚úÖ Branch '${TARGET_BRANCH}' already has up-to-date ledgers"
