# Update Indy Ledgers Strategy
#
# When does this workflow run?
#   - On every pull request (opened, synchronized, or reopened)
#
# When does this workflow create a commit?
#   - When the workflow detects changes in the `app/src/configs/ledgers/indy/ledgers.json` file
#     after running the `refresh-ledgers.cjs` script.
#   - Note: Auto-commit only works for PRs from branches in the same repo, not from forks.
#

name: Ledgers
description: Update Aries ledgers

permissions:
  contents: write

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  update-ledgers:
    runs-on: ubuntu-22.04
    name: Update Indy ledgers
    # Only run auto-commit for PRs from branches in the same repo (not forks)
    # For fork PRs, we still run to validate but skip the commit step
    env:
      HEAD_REPO: ${{ github.event.pull_request.head.repo.full_name || github.repository }}
      HEAD_REF: ${{ github.event.pull_request.head.ref || github.ref }}
      IS_FORK: ${{ github.event.pull_request.head.repo.full_name != github.repository }}
    steps:
      - name: Checkout bc-wallet-mobile
        uses: actions/checkout@v4
        with:
          repository: ${{ env.HEAD_REPO }}
          ref: ${{ env.HEAD_REF }}

      - name: Setup NodeJS
        uses: ./.github/workflows/actions/setup-node

      - name: Cache app node_modules
        uses: actions/cache@v3
        with:
          path: .yarn/cache
          # Cache will be invalidated if yarn.lock changes
          key: ${{ runner.os }}-yarn-${{ hashFiles('yarn.lock') }}
          restore-keys: ${{ runner.os }}-yarn-

      - name: Install dependencies
        working-directory: app
        run: yarn install --immutable

      - name: Update Indy ledgers
        run: node app/scripts/refresh-ledgers.cjs

      - name: Check for ledger changes
        id: check_changes
        run: |
          if git diff --quiet app/src/configs/ledgers/indy/ledgers.json; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No changes detected in ledgers.json"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Changes detected in ledgers.json"
          fi

      - name: Warn about fork PR
        if: steps.check_changes.outputs.changed == 'true' && env.IS_FORK == 'true'
        run: |
          echo "::warning::Ledgers have changed but cannot auto-commit to fork PRs. Please run 'node app/scripts/refresh-ledgers.cjs' locally and commit the changes."

      # note: picking a specific commit SHA to ensure the action is not updated unexpectedly and satisfies the SonarQube security requirements
      - name: Auto-commit ledger updates
        if: steps.check_changes.outputs.changed == 'true' && env.IS_FORK == 'false'
        uses: stefanzweifel/git-auto-commit-action@778341af668090896ca464160c2def5d1d1a3eb0
        with:
          # Optional. Commit message for the created commit.
          # Defaults to "Apply automatic changes"
          commit_message: 'chore(bot): updated Indy ledgers json file'

          # Optional. Options used by `git-commit`.
          # See https://git-scm.com/docs/git-commit#_options
          commit_options: '--no-verify --signoff'

          # Optional glob pattern of files which should be added to the commit
          # Defaults to all (.)
          # See the `pathspec`-documentation for git
          # - https://git-scm.com/docs/git-add#Documentation/git-add.txt-ltpathspecgt82308203
          # - https://git-scm.com/docs/gitglossary#Documentation/gitglossary.txt-aiddefpathspecapathspec
          file_pattern: 'app/src/configs/ledgers/indy/ledgers.json'

          # Optional. Option used by `git-status` to determine if the repository is
          # dirty. See https://git-scm.com/docs/git-status#_options
          status_options: '--porcelain app/src/configs/ledgers/indy/ledgers.json'

          # Optional. Disable dirty check and always try to create a commit and push
          skip_dirty_check: false
