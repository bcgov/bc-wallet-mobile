name: Native Build & Test

env:
  APP_BUILD_NUMBER: ${{ github.run_number }}

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - app/**
      - .yarn/**
      - .github/workflows/**
  pull_request:
    branches: [main]

jobs:
  check-secrets:
    runs-on: ubuntu-22.04
    steps:
      - name: Check secrets
        shell: bash
        run: |
          required_env_vars=(
            "PLAY_STORE_JKS_BASE64"
            "PLAY_STORE_JKS_ALIAS"
            "PLAY_STORE_JKS_PASSWD"
            "PLAY_STORE_JKS_BASE64_SADEV"
            "PLAY_STORE_JKS_ALIAS_SADEV"
            "PLAY_STORE_JKS_PASSWD_SADEV"
          )
          for var in "${required_env_vars[@]}"; do
            if [ -z "${!var}" ]; then
              echo "error: $var is not set."
              exit 1
            fi
          done
        env:
          PLAY_STORE_JKS_BASE64: ${{ secrets.PLAY_STORE_JKS_BASE64 }}
          PLAY_STORE_JKS_ALIAS: ${{ secrets.PLAY_STORE_JKS_ALIAS }}
          PLAY_STORE_JKS_PASSWD: ${{ secrets.PLAY_STORE_JKS_PASSWD }}
          PLAY_STORE_JKS_BASE64_SADEV: ${{ secrets.PLAY_STORE_JKS_BASE64_SADEV }}
          PLAY_STORE_JKS_ALIAS_SADEV: ${{ secrets.PLAY_STORE_JKS_ALIAS_SADEV }}
          PLAY_STORE_JKS_PASSWD_SADEV: ${{ secrets.PLAY_STORE_JKS_PASSWD_SADEV }}
  check-vars:
    runs-on: ubuntu-22.04
    steps:
      - name: Check variables
        shell: bash
        run: |
          required_env_vars=(
            "OCA_URL"
            "PROOF_TEMPLATE_URL"
            "MEDIATOR_USE_PUSH_NOTIFICATIONS"
            "INDY_VDR_PROXY_URL"
          )
          for var in "${required_env_vars[@]}"; do
            if [ -z "${!var}" ]; then
              echo "error: $var is not set."
              exit 1
            fi
          done
        env:
          OCA_URL: ${{ vars.OCA_URL }}
          PROOF_TEMPLATE_URL: ${{ vars.PROOF_TEMPLATE_URL }}
          MEDIATOR_USE_PUSH_NOTIFICATIONS: ${{ vars.MEDIATOR_USE_PUSH_NOTIFICATIONS }}
          INDY_VDR_PROXY_URL: ${{ vars.INDY_VDR_PROXY_URL }}

  early-exit-check:
    runs-on: ubuntu-22.04
    outputs:
      should_skip_build: ${{ steps.core_files_changed.outputs.result == 'false' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all branches, main needed.

      - name: Check if core files changed
        id: core_files_changed
        shell: bash
        run: |
          set -x

          # If this workflow was manually triggered, always force a build.
          if [ "${GITHUB_EVENT_NAME}" = "workflow_dispatch" ]; then
            echo "Manual workflow_dispatch run detected; forcing build regardless of diff."
            echo "result=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          if [ "${GITHUB_REF_NAME}" = "main" ]; then
            # On main branch, compare with the previous
            # commit otherwise (for PRs) compare with the
            # current commit.
            parent_ref="${GITHUB_REF_NAME:-main}^"
            child_ref="${GITHUB_SHA}"
          else
            # On PRs, compare with the base branch.
            parent_ref="origin/${GITHUB_BASE_REF:-main}"
            child_ref="HEAD"
          fi

          echo "Comparing ${parent_ref} with ${child_ref}"

          diff_output=$(git diff --name-only ${parent_ref}..${child_ref})
          change_count=$(echo "$diff_output" | (grep -E '^(app/.*)|(.yarn/.*)|(patch/.*)|(.github/workflows/.*)' || true) | wc -l | awk '{$1=$1};1')

          echo "$change_count files changed in app, .yarn, or .github/workflows"

          if [ $change_count -gt 0 ]; then
            # A result greater than 0 means there are changes
            # in the specified directories.
            echo "result=true" >> $GITHUB_OUTPUT
          else
            echo "result=false" >> $GITHUB_OUTPUT
          fi

  build-android-bcwallet:
    needs: [check-secrets, check-vars, early-exit-check]
    if: needs.early-exit-check.outputs.should_skip_build != 'true'
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      packages: write
    env:
      APP_VERSION: "1.0.27"
      ANDROID_PACKAGE_NAME: "ca.bc.gov.BCWallet"
      BUILD_TYPE: "bc-wallet"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Setup NodeJS
        uses: ./.github/workflows/actions/setup-node

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: "zulu"
          java-version: 17
          cache: "gradle"
          server-id: github
          settings-path: ${{ github.workspace }}

      - name: Install dependencies
        working-directory: ./
        run: |
          yarn install --immutable && \
          git status

      - name: Create environment settings
        working-directory: app
        env:
          BUILD_TARGET: "bcwallet"
          MEDIATOR_USE_PUSH_NOTIFICATIONS: ${{ vars.MEDIATOR_USE_PUSH_NOTIFICATIONS }}
          MEDIATOR_URL: ${{ secrets.MEDIATOR_URL }}
          IAS_PORTAL_URL: ${{ secrets.IAS_PORTAL_URL }}
          IAS_AGENT_INVITE_URL: ${{ secrets.IAS_AGENT_INVITE_URL }}
          OCA_URL: ${{ vars.OCA_URL }}
          PROOF_TEMPLATE_URL: ${{ vars.PROOF_TEMPLATE_URL }}
          REMOTE_LOGGING_URL: ${{ secrets.REMOTE_LOGGING_URL }}
          INDY_VDR_PROXY_URL: ${{ vars.INDY_VDR_PROXY_URL }}
        run: |
          echo "BUILD_TARGET=${BUILD_TARGET}" >.env
          echo "MEDIATOR_USE_PUSH_NOTIFICATIONS=${MEDIATOR_USE_PUSH_NOTIFICATIONS}" >>.env
          echo "MEDIATOR_URL=${MEDIATOR_URL}" >>.env
          echo "IAS_PORTAL_URL=${IAS_PORTAL_URL}" >>.env
          echo "IAS_AGENT_INVITE_URL=${IAS_AGENT_INVITE_URL}" >>.env
          echo "OCA_URL=${OCA_URL}" >>.env
          echo "PROOF_TEMPLATE_URL=${PROOF_TEMPLATE_URL}" >>.env
          echo "REMOTE_LOGGING_URL=${REMOTE_LOGGING_URL}" >>.env
          echo "INDY_VDR_PROXY_URL=${INDY_VDR_PROXY_URL}" >>.env

      - name: Create release keystore
        if: github.event.pull_request.head.repo.fork != true
        working-directory: app/android/app
        env:
          PLAY_STORE_JKS_BASE64: ${{ secrets.PLAY_STORE_JKS_BASE64 }}
          PLAY_STORE_JKS_ALIAS: ${{ secrets.PLAY_STORE_JKS_ALIAS }}
          PLAY_STORE_JKS_PASSWD: ${{ secrets.PLAY_STORE_JKS_PASSWD }}
        run: |
          echo "${PLAY_STORE_JKS_BASE64}" | base64 -d >release.keystore && \
          keytool -list -v -keystore release.keystore -alias ${PLAY_STORE_JKS_ALIAS} -storepass:env PLAY_STORE_JKS_PASSWD | \
          grep "SHA1"

      - name: Configure Gradle memory settings
        working-directory: app/android
        run: |
          echo "Configuring Gradle for maximum memory usage..."
          cat >> gradle.properties << EOF

          # Memory optimizations for CI
          org.gradle.jvmargs=-Xmx6144m -XX:MaxMetaspaceSize=1024m -XX:+HeapDumpOnOutOfMemoryError -XX:+UseParallelGC
          org.gradle.parallel=false
          org.gradle.configureondemand=false
          org.gradle.daemon=false
          org.gradle.caching=false

          # Kotlin compiler memory
          kotlin.daemon.jvmargs=-Xmx3072m

          # Android build optimizations
          android.enableR8.fullMode=false
          android.enableD8.desugaring=false
          EOF

          echo "Contents of gradle.properties:"
          cat gradle.properties

      - name: Android release build
        if: github.event.pull_request.head.repo.fork != true
        working-directory: app/android
        timeout-minutes: 45
        env:
          PLAY_STORE_JKS_ALIAS: ${{ secrets.PLAY_STORE_JKS_ALIAS }}
          PLAY_STORE_JKS_PASSWD: ${{ secrets.PLAY_STORE_JKS_PASSWD }}
          VERSION_CODE: ${{ env.APP_BUILD_NUMBER }}
          VERSION_NAME: ${{ env.APP_VERSION }}
          GRADLE_OPTS: "-Xmx6144m -XX:MaxMetaspaceSize=1024m"
          _JAVA_OPTIONS: "-Xmx6144m"
        run: |
          ( cd ../ && npx react-native bundle --platform android --dev false --entry-file index.js --bundle-output android/app/src/main/assets/index.android.bundle  --verbose ) && \
          ./gradlew bundleRelease assembleRelease --no-daemon --no-parallel

      - name: List Artifacts
        run: |
          find . -type f -name '*.apk'
          find . -type f -name '*.aab'

      - name: Upload Android AAB artifact
        if: github.ref_name == 'main'
        uses: actions/upload-artifact@v4
        with:
          name: android-bc-wallet-artifact-aab
          path: app/android/app/build/outputs/bundle/release/app-release.aab
          if-no-files-found: error
          retention-days: 7

      - name: Upload Android APK artifact
        if: github.ref_name == 'main'
        uses: actions/upload-artifact@v4
        with:
          name: android-bc-wallet-artifact-apk
          path: app/android/app/build/outputs/apk/release/app-release.apk
          if-no-files-found: error
          retention-days: 7

      - name: Ship to Google Play
        if: github.ref_name == 'main'
        env:
          GOOGLE_API_CREDENTIALS_BASE64: ${{ secrets.GOOGLE_API_CREDENTIALS_BASE64 }}
          GOOGLE_API_CREDENTIALS_FILE: "api_keys.json"
          ANDROID_BUNDLE_PATH: "app/android/app/build/outputs/bundle/release/app-release.aab"
          ANDROID_PACKAGE_NAME: ${{ env.ANDROID_PACKAGE_NAME }}
          VERSION_CODE: ${{ env.APP_BUILD_NUMBER }}
          VERSION_NAME: ${{ env.APP_VERSION }}
        run: |
          echo "${GOOGLE_API_CREDENTIALS_BASE64}" | base64 -d >${GOOGLE_API_CREDENTIALS_FILE} && \
          GOOGLE_API_CREDENTIALS="$PWD/${GOOGLE_API_CREDENTIALS_FILE}" npx @bcgov/gpublish

      - name: Clean up build artifacts
        if: always()
        run: |
          echo "Cleaning up to free space for next build..."
          rm -rf app/android/app/build
          rm -rf app/android/build
          rm -rf ~/.gradle/caches
          rm -rf app/.metro-cache

  build-android-singleapp:
    needs: [check-secrets, check-vars, early-exit-check, build-android-bcwallet]
    if: needs.early-exit-check.outputs.should_skip_build != 'true'
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      packages: write
    env:
      APP_VERSION: "4.0.0"
      ANDROID_PACKAGE_NAME: "ca.bc.gov.id.servicescard.dev"
      BUILD_TYPE: "single-app"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Setup NodeJS
        uses: ./.github/workflows/actions/setup-node

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: "zulu"
          java-version: 17
          cache: "gradle"
          server-id: github
          settings-path: ${{ github.workspace }}

      - name: Install dependencies
        working-directory: ./
        run: |
          yarn install --immutable && \
          git status

      - name: Patch for Single App build
        run: |
          echo "Patching for Single App build"
          git config user.email "github-action@users.noreply.github.com"
          git config user.name "GitHub Actions"
          git am < ./patch/0001-chore-android-app-to-bcsc-dev.patch

      - name: Create environment settings
        working-directory: app
        env:
          BUILD_TARGET: "bcsc"
          MEDIATOR_USE_PUSH_NOTIFICATIONS: ${{ vars.MEDIATOR_USE_PUSH_NOTIFICATIONS }}
          MEDIATOR_URL: ${{ secrets.MEDIATOR_URL }}
          IAS_PORTAL_URL: ${{ secrets.IAS_PORTAL_URL }}
          IAS_AGENT_INVITE_URL: ${{ secrets.IAS_AGENT_INVITE_URL }}
          OCA_URL: ${{ vars.OCA_URL }}
          PROOF_TEMPLATE_URL: ${{ vars.PROOF_TEMPLATE_URL }}
          REMOTE_LOGGING_URL: ${{ secrets.REMOTE_LOGGING_URL }}
          INDY_VDR_PROXY_URL: ${{ vars.INDY_VDR_PROXY_URL }}
        run: |
          echo "BUILD_TARGET=${BUILD_TARGET}" >.env
          echo "MEDIATOR_USE_PUSH_NOTIFICATIONS=${MEDIATOR_USE_PUSH_NOTIFICATIONS}" >>.env
          echo "MEDIATOR_URL=${MEDIATOR_URL}" >>.env
          echo "IAS_PORTAL_URL=${IAS_PORTAL_URL}" >>.env
          echo "IAS_AGENT_INVITE_URL=${IAS_AGENT_INVITE_URL}" >>.env
          echo "OCA_URL=${OCA_URL}" >>.env
          echo "PROOF_TEMPLATE_URL=${PROOF_TEMPLATE_URL}" >>.env
          echo "REMOTE_LOGGING_URL=${REMOTE_LOGGING_URL}" >>.env
          echo "INDY_VDR_PROXY_URL=${INDY_VDR_PROXY_URL}" >>.env

      - name: Create release keystore
        if: github.event.pull_request.head.repo.fork != true
        working-directory: app/android/app
        env:
          PLAY_STORE_JKS_BASE64: ${{ secrets.PLAY_STORE_JKS_BASE64_SADEV }}
          PLAY_STORE_JKS_ALIAS: ${{ secrets.PLAY_STORE_JKS_ALIAS_SADEV }}
          PLAY_STORE_JKS_PASSWD: ${{ secrets.PLAY_STORE_JKS_PASSWD_SADEV }}
        run: |
          echo "${PLAY_STORE_JKS_BASE64}" | base64 -d >release.keystore && \
          keytool -list -v -keystore release.keystore -alias ${PLAY_STORE_JKS_ALIAS} -storepass:env PLAY_STORE_JKS_PASSWD | \
          grep "SHA1"

      - name: Configure Gradle memory settings
        working-directory: app/android
        run: |
          echo "Configuring Gradle for maximum memory usage..."
          cat >> gradle.properties << EOF

          # Memory optimizations for CI
          org.gradle.jvmargs=-Xmx6144m -XX:MaxMetaspaceSize=1024m -XX:+HeapDumpOnOutOfMemoryError -XX:+UseParallelGC
          org.gradle.parallel=false
          org.gradle.configureondemand=false
          org.gradle.daemon=false
          org.gradle.caching=false

          # Kotlin compiler memory
          kotlin.daemon.jvmargs=-Xmx3072m

          # Android build optimizations
          android.enableR8.fullMode=false
          android.enableD8.desugaring=false
          EOF

          echo "Contents of gradle.properties:"
          cat gradle.properties

      - name: Android release build
        if: github.event.pull_request.head.repo.fork != true
        working-directory: app/android
        timeout-minutes: 45
        env:
          PLAY_STORE_JKS_ALIAS: ${{ secrets.PLAY_STORE_JKS_ALIAS_SADEV }}
          PLAY_STORE_JKS_PASSWD: ${{ secrets.PLAY_STORE_JKS_PASSWD_SADEV }}
          VERSION_CODE: ${{ env.APP_BUILD_NUMBER }}
          VERSION_NAME: ${{ env.APP_VERSION }}
          GRADLE_OPTS: "-Xmx6144m -XX:MaxMetaspaceSize=1024m"
          _JAVA_OPTIONS: "-Xmx6144m"
        run: |
          ( cd ../ && npx react-native bundle --platform android --dev false --entry-file index.js --bundle-output android/app/src/main/assets/index.android.bundle  --verbose ) && \
          ./gradlew bundleRelease assembleRelease --no-daemon --no-parallel

      - name: List Artifacts
        run: |
          find . -type f -name '*.apk'
          find . -type f -name '*.aab'

      - name: Upload Android AAB artifact
        if: github.ref_name == 'main'
        uses: actions/upload-artifact@v4
        with:
          name: android-single-app-artifact-aab
          path: app/android/app/build/outputs/bundle/release/app-release.aab
          if-no-files-found: error
          retention-days: 7

      - name: Upload Android APK artifact
        if: github.ref_name == 'main'
        uses: actions/upload-artifact@v4
        with:
          name: android-single-app-artifact-apk
          path: app/android/app/build/outputs/apk/release/app-release.apk
          if-no-files-found: error
          retention-days: 7

      - name: Ship to Google Play
        if: github.ref_name == 'main'
        env:
          GOOGLE_API_CREDENTIALS_BASE64: ${{ secrets.GOOGLE_API_CREDENTIALS_BASE64 }}
          GOOGLE_API_CREDENTIALS_FILE: "api_keys.json"
          ANDROID_BUNDLE_PATH: "app/android/app/build/outputs/bundle/release/app-release.aab"
          ANDROID_PACKAGE_NAME: ${{ env.ANDROID_PACKAGE_NAME }}
          VERSION_CODE: ${{ env.APP_BUILD_NUMBER }}
          VERSION_NAME: ${{ env.APP_VERSION }}
        run: |
          echo "${GOOGLE_API_CREDENTIALS_BASE64}" | base64 -d >${GOOGLE_API_CREDENTIALS_FILE} && \
          GOOGLE_API_CREDENTIALS="$PWD/${GOOGLE_API_CREDENTIALS_FILE}" npx @bcgov/gpublish

      - name: Clean up build artifacts
        if: always()
        run: |
          echo "Cleaning up to free space..."
          rm -rf app/android/app/build
          rm -rf app/android/build
          rm -rf ~/.gradle/caches
          rm -rf app/.metro-cache

  build-summary:
    runs-on: ubuntu-latest
    needs:
      - early-exit-check
      - build-android-bcwallet
      - build-android-singleapp
    if: always()
    steps:
      - name: Check matrix results
        run: |
          if [ "${{ needs.early-exit-check.outputs.should_skip_build }}" == "true" ]; then
            echo "✅ Nothing to build. Early exit okay"
            exit 0
          fi

          if [ "${{ needs.build-android-bcwallet.result }}" != "success" ]; then
            echo "BC Wallet Android build failed"
            exit 1
          fi

          if [ "${{ needs.build-android-singleapp.result }}" != "success" ]; then
            echo "Single App Android build failed"
            exit 1
          fi

          echo "✅ All builds passed!"
  ship-to-saucelabs:
    if: false # Disabled
    # if: github.ref_name == 'main'
    needs: [build-android-bcwallet, build-android-singleapp]
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        include:
          - platform: "android"
            build_type: "bc-wallet"
            artifact_ref: "android-bc-wallet-artifact-aab"
            sauce_labs_name: "BCWallet-${{ github.run_number }}.aab"
            sauce_labs_description: "Android BC Wallet App"
            artifact_name: "app-release.aab"
          - platform: "android"
            build_type: "single-app"
            artifact_ref: "android-single-app-artifact-aab"
            sauce_labs_name: "BCWallet-SingleApp-${{ github.run_number }}.aab"
            sauce_labs_description: "Android BC Wallet Single App"
            artifact_name: "app-release.aab"
    steps:
      - uses: actions/checkout@v4

      - name: Ship Artifact to SauceLabs
        uses: ./.github/workflows/actions/ship-to-saucelabs
        with:
          sauce_labs_username: ${{ secrets.SAUCE_USERNAME }}
          sauce_labs_password: ${{ secrets.SAUCE_ACCESS_KEY }}
          sauce_labs_name: ${{ matrix.sauce_labs_name }}
          sauce_labs_description: ${{ matrix.sauce_labs_description }}
          artifact_ref: ${{ matrix.artifact_ref }}
          artifact_name: ${{ matrix.artifact_name }}

  run-on-device-tests:
    # if: github.ref_name == 'main'
    if: false # Disabled
    needs: [ship-to-saucelabs]
    runs-on: ubuntu-22.04
    strategy:
      max-parallel: 4
      fail-fast: false
      matrix:
        include:
          - mobile-platform: "-p Android"
            app-file-name: "-a BCWallet-${{ github.run_number }}.aab"
            report-project: "android-bc-wallet-one-device-smoke"
          # - mobile-platform: "-p Android"
          #   app-file-name: "-a BCWallet-SingleApp-${{ github.run_number }}.aab"
          #   report-project: "android-single-app-one-device-smoke"
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4

      - name: run-aath-agents-ngrok
        uses: ./.github/workflows/actions/run-aath-agents
        with:
          NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTHTOKEN }}
          USE_NGROK: "-n"

      - name: Fetch mobile test harness repo
        uses: actions/checkout@v4
        with:
          repository: hyperledger/aries-mobile-test-harness
          path: aries-mobile-test-harness
          ref: main

      - name: Run SauceLabs smoke-test
        uses: ./.github/workflows/actions/run-test-harness
        env:
          LEDGER_URL_CONFIG: "http://test.bcovrin.vonx.io"
          REGION: "us-west-1"
        with:
          MOBILE_WALLET: "-w bc_wallet"
          ISSUER_AGENT: '-i "AATH;http://0.0.0.0:9020"'
          VERIFIER_AGENT: '-v "AATH;http://0.0.0.0:9030"'
          DEVICE_CLOUD: "-d SauceLabs"
          DEVICE_CLOUD_USER: "-u ${{ secrets.SAUCE_USERNAME }}"
          DEVICE_CLOUD_KEY: "-k ${{ secrets.SAUCE_ACCESS_KEY }}"
          MOBILE_PLATFORM: ${{ matrix.mobile-platform }}
          APP_FILE_NAME: ${{ matrix.app-file-name }}
          TEST_SCOPE: "-t @bc_wallet -t @SmokeTest"
          REPORT_PROJECT: ${{ matrix.report-project }}

      - name: Upload smoke-test results to Allure
        if: always()
        uses: ./.github/workflows/actions/run-send-gen-test-results-secure
        with:
          REPORT_PROJECT: ${{ matrix.report-project }}
          ADMIN_USER: ${{ secrets.ALLURE_USERNAME }}
          ADMIN_PW: ${{ secrets.ALLURE_PASSWD }}
